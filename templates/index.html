<!DOCTYPE html>
<html lang="en">
<head>
  <title>Metal Halide Perovskite Structure Generator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/static/js/JSmol.min.js"></script>
</head>
<body>

  <div class="container">
    <h1>Metal Halide Perovskite Structure Generator</h1>
    <h3>Enter details of the Structure you would like:</h3>
  </div>
  <div class="row">
    <div class="col-md-6 col-md-offset-1">
      <form method="post" id="parameterForm">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="inputType">Type</label>
            <select class="form-control" id="inputType" name="type">
              <option value='3D'>3D</option>
              <option value='RP'>2D Ruddlesden-Popper</option>
              <option value='DJ'>2D Dion-Jacobson</option>
            </select>
          </div>
          <div class="form-group col-md-4 col-md-offset-4">
            <label for="inputN">N</label>
            <select class="form-control" id="inputN" name="n" disabled>
              <option value="1">n=1</option>
              <option value="2">n=2</option>
              <option value="3">n=3</option>
              <option value="4">n=4</option>
              <option value="5">n=5</option>
              <option value="6">n=6</option>
              <option value="7">n=7</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label for="inputCation">Cation</label>
            <select class="form-control" id="inputCation" name="cation">
              <option value="MA">Methylammonium (MA)</option>
              <option value="Cs">Cesium (Cs)</option>
              <option value="FA">Formamadinium (FA)</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label for="inputMetal">Metal</label>
            <select class="form-control" id="inputMetal" name="metal">
              <option value="Pb">Lead (Pb)</option>
              <option value="Sn">Tin (Sn)</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label for="inputHalide">Halide</label>
            <select class="form-control" id="inputHalide" name="halide">
              <option value="I">Iodide (I)</option>
              <option value="Br">Bromide (Br)</option>
              <option value="Cl">Chloride (Cl)</option>
            </select>
          </div>
          <div class="form-group col-md-6">
            <label for="inputRPLigand">Organic Ligand (RP)</label>
            <select class="form-control" id="inputRPLigand" name="rpLigand" disabled>
              <option value="BA">Butylammonium (BA)</option>
              <option value="PEA">Phenethylammonium (PEA)</option>
              <option value="PMA">Phenylmethylammonium (PMA)</option>
            </select>
          </div>
          <div class="form-group col-md-6">
            <label for="inputDJLigand">Organic Ligand (DJ)</label>
            <select class="form-control" id="inputDJLigand" name="djLigand" disabled>
              <option value="BDA">Butane 1,4 Diammonium (BDA)</option>
              <option value="PDA">Propane 1,3 Diammonium (PDA)</option>
              <option value="DMPD">N,N-dimethylpropane- 1,3-diammonium (DMPD)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="inputLayer">Layer Spacing (&#8491;)</label>
            <input type="text" class="form-control" id="inputLayer" value="13.8" name="layer" disabled>
          </div>
          <div class="form-group col-md-4 col-md-offset-4">
            <label for="inputBond">Metal-Halide Bond Length (&#8491;)</label>
            <input type="text" class="form-control" id="inputBond" value="3.39" name="bond">
          </div>
          <div class="form-group col-md-4">
            <label for="inputAlpha">Octahedral tilt &alpha; (in degrees)</label>
            <input type="text" class="form-control" id="inputAlpha" value="0" name="atilt">
          </div>
          <div class="form-group col-md-4">
            <label for="inputBeta">&beta; (in degrees)</label>
            <input type="text" class="form-control" id="inputBeta" value="0" name="btilt">
          </div>
          <div class="form-group col-md-4">
            <label for="inputGamma">&gamma; (in degrees)</label>
            <input type="text" class="form-control" id="inputGamma" value="0" name="ctilt">
          </div>
        </div>
        <div class="form-group col-md-4 col-md-offset-7">
          <button type="submit" class="btn btn-primary" id="submitButton">Build Structure</button>
          <button type="submit" class="btn btn-primary" id="ciflink">Download .cif file</button>
        </div>
      </form>
    </div>
    <div class="col-md-4">
        <script type="text/javascript">
          var acted=0;
          function readyfunc()
           {
            Jmol.script(JmolApplet0, "select all ; zoom 60;");
           };
          var Info = {
        // Let the applet fill the whole width of the popup, but leave some space at the
        //  bottom of the window for any html output
        // By using %s, the applet will be resized if the window is resized
          height: 500,
          width: 500,
        // php sets the Jmol variable Info.use
          use: "HTML5",
        // The next line assumes that the .jar files in the Jmol distribution have been moved
        //  to the top level of the Jmol library directory
          jarPath: "/static/JmolFolder/jsmol",
          j2sPath: "/static/JmolFolder/jsmol/j2s",
        // The signed applet will be used
          jarFile: "JmolAppletSigned0.jar",
          isSigned: true,
          console: "JmolApplet0_infodiv",
          readyFunction: readyfunc
          };
          JmolApplet0 = Jmol.getApplet("JmolApplet0", Info);
        // Now the applet exists, set up some Jmol parameters and load a Rasmol-style .spt script file
        //  which in turn loads the model from an .xyz coordinates file.
        // Because the .xyz format does not contain connectivity information, the bondTolerance
        //  parameter is set so as to make Jmol show bonds where chemists consider them to be.
        //  This is best found by trial and error for the molecules concerned,
        //   using the Jmol.jar stand-alone Java application.
        </script>
        <div id="jmolcontainer">
          <script type="text/javascript">
          Jmol.script(JmolApplet0, "axesOrientationRasmol=true; set measurementUnits angstroms; set bondTolerance 1.0;");
          Jmol.script(JmolApplet0,'load inline "0\n Nothing\n";');
          Jmol.script(JmolApplet0,"polyhedra;");
          Jmol.script(JmolApplet0,"unitcell RANGE {666};");
          Jmol.Button(JmolApplet0,"minimize","Minimize");
         </script>
         </div>
       </div>
    </div>
  <script>
    var radii={
      "I": 2.06,
      "Br":1.82,
      "Cl":1.67,
      "Pb":1.33,
      "Sn":1.10
    }
    $('#inputType').change(function() {
        $('#inputRPLigand').attr('disabled',$('#inputType option:selected').text()=="3D" || $('#inputType option:selected').text()=="2D Dion-Jacobson");
        $('#inputDJLigand').attr('disabled',$('#inputType option:selected').text()=="3D" || $('#inputType option:selected').text()=="2D Ruddlesden-Popper");
        $('#inputN').attr('disabled',$('#inputType option:selected').text()=="3D");
        $('#inputLayer').attr('disabled',$('#inputType option:selected').text()=="3D");
        $('#inputCation').attr('disabled',$('#inputN option:selected').text()=="n=1")
    });
  $('#inputN').change(function() {
      $('#inputCation').attr('disabled',$('#inputN option:selected').text()=="n=1");
  });

  $('#inputMetal').change(function() {
      $('#inputBond').val(radii[$('#inputMetal').val()]+radii[$('#inputHalide').val()]);
  });

  $('#inputHalide').change(function() {
      $('#inputBond').val(radii[$('#inputMetal').val()]+radii[$('#inputHalide').val()]);
  });

  $('#submitButton').click( function(event) {
    event.preventDefault();
    $("#jmolcontainer").load("/update",$('#parameterForm').serialize());
  });

  $('#ciflink').click( function(event) {
    event.preventDefault();
    $.get("/getcif",$('#parameterForm').serialize(),function(data){
      downloadString(data,"text/cif",$('#inputCation').val()+$('#inputMetal').val()+$('#inputHalide').val()+'.cif')
    });
  });
  function downloadString(text, fileType, fileName) {
    var blob = new Blob([text], { type: fileType });

    var a = document.createElement('a');
    a.download = fileName;
    a.href = URL.createObjectURL(blob);
    a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);
  }

  </script>
</body>
</html>
